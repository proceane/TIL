# Infrastructure Layer

## Definition
인프라 계층은 요청 시 데이터를 수신, 저장 및 제공함으로써 소프트웨어 시스템이 외부 시스템과 상호 작용할 수 있도록 합니다.([출처](https://www.techopedia.com/definition/32090/infrastructure-layer))  

## Repository Pattern
리포지토리는 데이터 소스에 액세스하기 위해 필요한 논리를 캡슐화하는 클래스 또는 구성요소  
리포지토리는 공통 데이터 액세스 기능에 집중해 더 나은 유지관리를 제공하고 도메인 모델 계층에서 데이터베이스에 엑세스하는 데 사용되는 기술이나 인프라를 분리함  

Martin Fowler는 리포지토리에 대해 다음과 같이 설명함  
> 리포지토리는 도메인 모델 계층과 데이터 매핑의 중간자 역할을 하며 메모리의 도메인 개체 집합에 대해서도 비슷한 방식으로 작업을 수행합니다. 클라이언트 개체는 쿼리를 선언적으로 빌드하고 리포지토리로 보내 답변합니다. 개념적으로, 리포지토리는 데이터베이스 내에 저장된 개체 집합과 수행할 수 있는 작업을 캡슐화해 지속성 계층에 더 가까운 방법을 제공합니다. 리포지토리는 또한 작업 도메인 및 데이터 할당 또는 매핑 간의 종속성을 명확하게 한 방향으로 구분하려는 목적을 지원합니다.  

## Defint One Repository per Aggregate
각 애그리거트 또는 애그리거트 루트에 대해 하나의 리포지토리 클래스를 만들어야 함  
DDD 패턴을 기반으로 한 마이크로 서비스에서 데이터베이스 업데이트에 사용해야하는 유일한 채널은 리포지토리여야 함  

리포지토리는 애그리거트의 고정 항목 및 트랜잭션 일관성을 제어하는 애그리거트 루트와 일대일 관계를 갖기 때문  

트랜잭션 영역(ex. 수정)은 언제나 애그리거트 루트와 리포지토리에 의해 제어되어야 함  

기본적으로 리포지토리는 데이터베이스에서 도메인 엔티티의 형태로 제공되는 메모리에 데이터를 채울 수 있음  

## Enforce One Aggregate Root per Repository
애그리거트 루트만 리포지토리를 갖는다는 규칙을 적용하는 것과 같은 방법으로 리포지터리를 구현하는 것은 유용할 수 있음  

인프라 계층에서 구현되는 각 리포지토리 클래스는 자체 계약이나 인터페이스를 구현함  

단, 각 리포지토리가 단일 애그리거트와 관련되어있는 규칙을 코드에서 적용하도록 하는 더 나은 방법은 제너릭 리포지토리 형식을 구현하는 것  
따라서 리포지토리는 특정 애그리거트를 대상으로 지정하는 것이 분명함  

### 정리
인프라스트럭쳐 계층은 리포지토리가 구현되는 곳  
리포지토리는 하나의 애그리거트 루트에 대해서만 구현됨  
반대로 애그리거트 루트도 하나의 리포지토리를 가짐  

## Reference
[infrastructure-persistence-layer-design](https://docs.microsoft.com/ko-kr/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design)